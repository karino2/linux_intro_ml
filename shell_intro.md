---
title: "環境設定のためのシェル入門"
layout: page
---

機械学習屋は通常のシスアドほどはシェルに詳しい必要はありません。

ですがコンテナとインスタンスの設定は凄くしょっちゅうやる事になるので、
簡単なトラブルシューティングは自分で出来る方が良いです。
また、大きな学習データを扱うのにシェルを使うケースもちょこちょこ出てきます。

ここではそうした事を踏まえて、機械学習で必要な程度のシェルの入門をしたいと思います。

良くある設定として、以下が理解出来るくらいを目指します。（これは私のインスタンスの設定用スクリプトです）

- [GCP Setup, debian, non gpu](https://gist.github.com/karino2/347f40df3b95a1de77fec240d45b3fde#file-setup-sh-L28-L29)

# いろいろなクオートと変数の展開

シェルの文字列のクオートには、シングルクオートとダブルクオートとバッククオートの三種類があり、それぞれ意味が違います。

### echoに見る、クオートが無い場合とある場合の違い

echoで、「Hello  World」と、間に空白を二つ入れたいとします。
以下のようにすると、

```
$ echo Hello  World
Hello World
```

空白が一つになってしまいます。

echoコマンドからは、`echo Hello  World`というのは、

- 第一引数としてHello
- 第二引数としてWorld

が渡されている、と見えて、間の空白というのはシェルが処理する事になります。

シェルは空白で区切って最初の文字列をコマンド、それ以降を引数として配列に詰めて渡します。
この時、間の空白が幾つかとかはシェルは気にしません。そしてechoまで辿り着いた時には、間の空白が二つあったという情報は失われます。

では空白を二つ挟んだ結果を出したい場合はどうしたらいいでしょう？
ダブルクオートで囲むのが普通の解決策です。

```
$ echo "Hello  World"
```

こうすると、echoからは第一引数に「Hello  World」が渡された、と見えます。
引数は一つと解釈されます。これはechoというよりはシェルの振る舞いなのでそのほかのコマンドでも同じ事が言えます。（あとでシェルスクリプトをやった時にさらに確認します）


### シェルの変数

シェルには変数という物があります。
変数はイコールで代入する事で作られます。
例えば以下でHOGEという変数が出来ます。

```
$ HOGE=abc
```

これでHOGEという変数にabcという文字列が入ります。

変数は参照する時はドル記号をつけます。例えばechoを使うと、以下のようになります。

```
$ echo $HOGE
abc
```

シェルは、`$HOGE`とあったら変数の中身に置き換えてechoに渡します。
echoコマンドからはHOGEという変数だったという事実は分からず、abcという文字列が最初から渡されたのと区別出来ません。

### シングルクオートとダブルクオートと変数展開

文字列をダブルクオートで囲むと、中に変数があった場合、それが展開されます。

```
$ echo "ika$HOGE"
ikaabc
```

ですが、以下のようにすると、何も表示されません。

```
$ echo "$HOGEika"

```

これは、`$HOGE`という変数のあとにikaがあるのではなく、`$HOGEika`という別の変数があると勘違いする為です。

HOGEで切りたい場合は中括弧でくくります。

```
$ echo "${HOGE}ika"
abcika
```

シェルでは、文字列をシングルクオートでくくる事も出来ます。
シングルクオートの場合、中の変数は展開されません。

```
$ echo '${HOGE}ika'
${HOGE}ika
```

### バッククオートと`$()`

シェルスクリプトにはさらに、バッククオート、つまり`\``でくくる、というのがあります。
バッククオートはプログラム以外ではあまり使わないのでキーボード上で探さないといけない人もいるかもしれませんね。（なお私の手元のキーボードではシフトを押しながらアットマークのキーでした）

バッククオートで囲まれた部分は、「その中をシェルスクリプトとして、子プロセスで実行し、そこで得られた標準出力で置き換える」という機能になります。

言葉にするとややこしいので例をみましょう。

まず一番簡単なのがechoを使う例です。

```
$ echo hoge_`echo ika`_fuga
hoge_ika_fuga
```

バッククオートの中は`echo ika`なので、これを実行した結果の標準出力、つまり`ika`で展開されます。

もう少し他の例も見て見ましょう。例えば以下みたいなスクリプトを実行してみましょう。

```
~$ echo hoge_`cd /etc; pwd`_fuga
hoge_/etc_fuga
~$
```

バッククオートの中は`cd /etc; pwd`なので標準出力には/etcでpwdした結果、つまり`/etc`が得られるでしょう。

ここで着目して欲しいのは、呼び出し元のシェルでは作業ディレクトリが/etcになってない、という所です。
バッククオートの中は子プロセスとして実行されるので、呼び出し元のシェルには影響がありません。
だからこの中でcdしても問題が無い。

なお、バッククオートの他に`$(シェルのコマンド)`という記法もあって、効果は一緒です。
つまり上記のechoは`echo hoge_$(cd /etc; pwd)_fuga`と書いても良い。
複数行に渡る場合はこちらが多く使われるようです。

### 実際の例

dockerのサイトからインストール方法を調べると、以下のようなスクリプトを実行せよ、と書かれています。（[GCP Setup, debian, non gpu](https://gist.github.com/karino2/347f40df3b95a1de77fec240d45b3fde)にも入っています）

```
curl -fsSL https://download.docker.com/linux/$(. /etc/os-release; echo "$ID")/gpg | sudo apt-key add -
```

curlやapt-keyなどはおいといて、URLの部分はここで学んだ知識が使われていますね。
curlはやめてechoにしてみましょう。

```
$ echo https://download.docker.com/linux/$(. /etc/os-release; echo "$ID")
https://download.docker.com/linux/ubuntu
```

私の環境ではubuntuと展開されるようです。
`$()`の中を見るとドットで始まっています。これは解説してないですが、引数のファイルを現在のシェルで実行する、という機能です。実行されるシェルスクリプトを見てみましょう。

```
$ cat /etc/os-release
NAME="Ubuntu"
VERSION="18.04.3 LTS (Bionic Beaver)"
ID=ubuntu
ID_LIKE=debian
PRETTY_NAME="Ubuntu 18.04.3 LTS"
VERSION_ID="18.04"
HOME_URL="https://www.ubuntu.com/"
SUPPORT_URL="https://help.ubuntu.com/"
BUG_REPORT_URL="https://bugs.launchpad.net/ubuntu/"
PRIVACY_POLICY_URL="https://www.ubuntu.com/legal/terms-and-policies/privacy-policy"
VERSION_CODENAME=bionic
UBUNTU_CODENAME=bionic
```

どうやらこのLinuxがどういうディストリビューションか、とか、バージョンとかが書かれているようですね。これらは変数として代入されていきます。そしてこのスクリプトを実行したあとに`echo $ID`を実行しているので、このファイルに書かれているIDが展開された結果が標準出力に出るのでしょう。

せっかくなので試しにこの仮説があっているかを確認してみましょう。

```
$ . /etc/os-release
$ echo $ID
ubuntu
```

あってそうですね。

なお、`$()`の中は子プロセスで実行されるので、元のスクリプトではechoしたあとにはこの変数は消えているはずです。

このようにURLやファイルのパスの一部を作ったり、コマンドラインの引数の一部を使うのにバッククオートや`$()`は良く使われます。

# 環境変数入門



環境変数とは何か、とか、子プロセスがどうなるか、とか。
.bashrcとかの話もここでしておくか？

### モードとかユーザーとか

chownとかchmodとかwo am iとかユーザーとか。
コンテナ上でルートで作業した時にvmountしているファイルのパミッションが変わる話とかをする。
xargsとか使って一気にchmodしたり。

基本コマンドの方のManaging files and foldersに一通りの話があるので補足する感じで。


# シェルスクリプト入門

本当に入門だけ。なるべくJupyter上でやろう。
